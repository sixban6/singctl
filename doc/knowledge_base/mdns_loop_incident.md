# mDNS 查询风暴问题总结

## 1. 问题的起因

在 Sing-box 的 TProxy（透明代理）模式下，脚本使用 `nftables` 或 `iptables` 将局域网内的流量劫持并转发给 sing-box 处理。为了防止代理环路和确保局域网互访正常，脚本中定义了一个 **白名单机制**（`LOCAL_IPV4` 和 `ip6 daddr` 规则），凡是在白名单内的目标 IP 地址，流量都会被直接放行（Accept），不经过 sing-box。

**根本原因**：
原有的白名单配置中，漏掉了 **组播（Multicast）** 和 **广播（Broadcast）** 地址段。
- **IPv4 组播**：`224.0.0.0/4`（包含 mDNS `224.0.0.251`）
- **IPv4 广播**：`255.255.255.255/32`
- **IPv6 组播**：`ff00::/8`（包含 mDNS `ff02::fb`）

由于这些地址不在白名单内，局域网设备发出的 mDNS 查询请求（如 Apple 设备的发现协议，目标端口 UDP 5353）被防火墙规则捕获并重定向到了 sing-box。sing-box 接收到这些组播流量后，可能因为无法正确处理或重新发出查询时再次被劫持，导致了流量环路或“查询风暴”。

## 2. 问题的现象

1.  **大量的 DNS/mDNS 查询记录**：
    在 sing-box 的日志或控制面板中，可以看到海量的连接请求，目标地址为 `224.0.0.251` (IPv4 mDNS) 或 `ff02::fb` (IPv6 mDNS)，端口通常为 5353。
    
2.  **网络性能下降**：
    由于大量的无效查询占用连接数和 CPU 资源，可能导致旁路由性能下降，甚至影响局域网内其他设备的网络体验。

3.  **日志刷屏**：
    后台日志充斥着关于 UDP 5353 的处理记录或错误信息。

4.  **直连无此问题**：
    如果直接运行 `sing-box run` 而不使用 TProxy 脚本（即不配置防火墙劫持规则），则一切正常，这也反向证明了问题出在流量劫持规则上。

## 3. 解决的方案

解决方案的核心是将组播和广播地址加入到防火墙的 **白名单（直连不代理）** 中。

### 修改 `start_singbox.sh` (OpenWrt)

1.  **IPv4 白名单增强**：
    在 `LOCAL_IPV4` 变量中追加组播和广播地址：
    ```bash
    LOCAL_IPV4='{..., 224.0.0.0/4, 255.255.255.255/32}'
    ```

2.  **IPv6 白名单增强** (nftables)：
    在 `prerouting` 和 `output` 链的 IPv6 放行规则中，追加 `ff00::/8`：
    ```bash
    ip6 daddr { ::1, fc00::/7, fe80::/10, ff00::/8 } accept
    ```

### 修改 `start_singbox_debian.sh` (Debian)

1.  **IPv4 白名单增强**：
    同样更新 `LOCAL_IPV4` 变量。

2.  **IPv6 白名单增强** (nftables 模式)：
    同样更新 `ip6 daddr` 规则，加入 `ff00::/8`。

3.  **兼容性修复** (iptables 模式)：
    在 `iptables` 规则中显式添加 RETURN 规则：
    ```bash
    iptables -t mangle -A SINGBOX -d 224.0.0.0/4 -j RETURN
    iptables -t mangle -A SINGBOX -d 255.255.255.255/32 -j RETURN
    ```

### 其他潜在原因排查

除了组播/广播漏放外，以下情况也可能导致类似问题，需注意：
- **DNS 环路**：sing-box 发出的 DNS 请求被防火墙再次拦截（需确保 sing-box 出站流量有正确的 `fwmark` 标记豁免）。
- **时间同步失败**：导致 TLS 连接大量报错重试。
- **P2P/BT 流量**：若未过滤，大量 UDP 连接会冲击代理。
